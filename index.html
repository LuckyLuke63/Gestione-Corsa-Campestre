<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Gestione Iscritti Corsa Campestre</title>
  <style>
    /* Variabili CSS per colori principali */
    :root {
      --primary-color: #3b82f6; /* blue-500 */
      --primary-dark: #2563eb; /* blue-600 */
      --secondary-bg: #f3f4f6; /* gray-100 */
      --border-color: #d1d5db; /* gray-300 */
      --text-color: #1f2937;
    }
    
    /* Stile generale e container principale */
    body { 
      font-family: ui-sans-serif, system-ui, sans-serif, "Arial"; 
      margin: 0; 
      padding: 3rem; 
      background: #f9fafb; /* Sfondo generale */
    }
    .container {
      max-width: 1280px;
      margin: 0 auto;
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
      padding: 2rem;
    }
    h1 {
      font-size: 2rem;
      font-weight: 800;
      color: var(--text-color);
      margin-bottom: 1.5rem;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 0.75rem;
    }

    /* Controlli e filtri */
    .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 2rem;
        padding: 1rem;
        background: var(--secondary-bg);
        border-radius: 0.5rem;
        align-items: center;
    }

    /* Stile Pulsanti Generici (Importa e Svuota) */
    #upload-label, #svuota-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        font-weight: 600;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    #upload-label {
        background-color: var(--primary-color);
        color: white;
    }
    #upload-label:hover {
        background-color: var(--primary-dark);
    }
    #upload { display: none; }

    #svuota-btn {
        background-color: #ef4444; /* red-500 */
        color: white;
        border: none;
    }
    #svuota-btn:hover {
        background-color: #dc2626; /* red-600 */
    }

    /* Filtro Sesso */
    .filter-group { display: flex; align-items: center; gap: 0.5rem; }
    .filter-group label { color: #4b5563; font-weight: 500; }
    #filtroSesso {
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        transition: border-color 0.2s;
    }
    #filtroSesso:focus { border-color: var(--primary-color); outline: none; }

    /* Contatore Atleti */
    .count-display {
        margin-left: auto;
        padding: 0.5rem 1rem;
        background-color: #bfdbfe; /* blue-200 */
        color: #1e40af; /* blue-800 */
        font-weight: 700;
        border-radius: 0.5rem;
    }

    /* Tabella (Container) */
    .table-wrapper {
      overflow-x: auto;
      max-height: 60vh; /* Permette all'header di essere sticky */
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
    }

    table { 
      border-collapse: collapse; 
      width: 100%; 
      font-size: 0.875rem; /* text-sm */
    }

    th, td { 
      padding: 0.5rem 0.75rem; 
      text-align: left; 
      border-right: 1px solid #e5e7eb;
      border-bottom: 1px solid #f3f4f6; 
    }

    /* Header Fisso (Sticky) */
    thead tr {
        background: var(--secondary-bg);
        color: #4b5563; /* gray-600 */
        position: sticky;
        top: 0;
        z-index: 10;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }
    
    th button {
        background: none;
        border: none;
        cursor: pointer;
        font-weight: 600;
        color: inherit;
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding: 0;
    }
    th button:hover { color: var(--primary-dark); }

    /* Righe a Strisce (Zebra Stripes) e Hover */
    tbody tr:nth-child(even) { background-color: #f9fafb; /* gray-50 */ }
    tbody tr:hover { background-color: #eff6ff; /* blue-50 */ }
    
    /* Indicatore di ordinamento (simulazione icone) */
    .sort-icon {
        width: 1rem;
        height: 1rem;
        margin-left: 0.25rem;
        display: inline-block;
        font-size: 0.8rem;
        transition: color 0.2s;
    }
    
    .sort-icon.default { color: #9ca3af; }
    .sort-icon.asc { color: var(--primary-dark); }
    .sort-icon.desc { color: var(--primary-dark); }
  </style>
</head>
<body>
    <div class="container">
      <h1>Gestione Iscritti Corsa Campestre</h1>
      
      <div class="controls">
        <label id="upload-label">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
          <span>Importa Excel</span>
          <input type="file" id="upload" accept=".xls,.xlsx" />
        </label>

        <button id="svuota-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
            Svuota tabella
        </button>

        <div class="filter-group">
            <label for="filtroSesso">Filtra per sesso:</label>
            <select id="filtroSesso">
              <option value="Tutti">Tutti</option>
              <option value="M">M</option>
              <option value="F">F</option>
            </select>
        </div>
        
        <div class="count-display">
            Atleti visualizzati: <span id="atleti-count">0</span>
        </div>
      </div>
      
      <div id="no-data" style="text-align: center; padding: 4rem; color: #9ca3af; background-color: #f9fafb; border: 2px dashed #e5e7eb; border-radius: 0.75rem;">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin: 0 auto 1rem; color: #d1d5db;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
          <p style="font-size: 1.25rem; font-weight: 600;">Nessun atleta nel database</p>
          <p style="font-size: 0.875rem; margin-top: 0.25rem;">Carica un file Excel per iniziare</p>
      </div>

      <div class="table-wrapper" style="display: none;">
          <table id="tabella">
            <thead>
              <tr>
                <th data-key="pettorale">
                    <button>Pettorale <span class="sort-icon default">↕</span></button>
                </th>
                <th data-key="cognome">
                    <button>Cognome <span class="sort-icon default">↕</span></button>
                </th>
                <th data-key="nome">
                    <button>Nome <span class="sort-icon default">↕</span></button>
                </th>
                <th data-key="sesso">
                    <button>Sesso <span class="sort-icon default">↕</span></button>
                </th>
                <th data-key="dataNascita">
                    <button>Data Nascita <span class="sort-icon default">↕</span></button>
                </th>
                <th data-key="categoria1">
                    <button>Categoria1 <span class="sort-icon default">↕</span></button>
                </th>
                <th data-key="societa">
                    <button>Società <span class="sort-icon default">↕</span></button>
                </th>
              </tr>
            </thead>
            <tbody>
              </tbody>
          </table>
      </div>
    </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <script>
    let atleti = [];
    let colonnaOrdinamento = null; 
    let direzioneOrdinamento = 'asc';
    
    // Mappa le chiavi interne del modello dati agli indici della colonna Excel
    const colonneMappate = {
        'pettorale': 0, 'cognome': 1, 'nome': 2, 'sesso': 4, 'dataNascita': 5, 'categoria1': 6, 'societa': 7
    };

    /**
     * Confronta due valori per l'ordinamento, gestendo numeri, date e stringhe.
     */
    function confrontaValori(a, b, colonna, direzione) {
        let valA = a[colonna];
        let valB = b[colonna];

        if (colonna === 'pettorale') {
            valA = Number(valA) || 0;
            valB = Number(valB) || 0;
        } else if (colonna === 'dataNascita') {
            // Conversione da dd/mm/yyyy a yyyymmdd per un confronto numerico corretto delle date
            const parseDate = (dateStr) => {
                if (!dateStr || dateStr.length !== 10) return 0;
                const parts = dateStr.split('/'); // dd/mm/yyyy
                return Number(parts[2] + parts[1] + parts[0]); 
            };
            valA = parseDate(valA);
            valB = parseDate(valB);
        } else {
            valA = String(valA).toLowerCase();
            valB = String(valB).toLowerCase();
        }

        let confronto = 0;
        if (valA > valB) { confronto = 1; } 
        else if (valA < valB) { confronto = -1; }

        return direzione === 'asc' ? confronto : -confronto;
    }

    /**
     * Esegue l'ordinamento dei dati e aggiorna la visualizzazione.
     */
    function ordinaTabella(colonna) {
        if (colonnaOrdinamento === colonna) {
            direzioneOrdinamento = direzioneOrdinamento === 'asc' ? 'desc' : 'asc';
        } else {
            colonnaOrdinamento = colonna;
            direzioneOrdinamento = 'asc';
        }
        atleti.sort((a, b) => confrontaValori(a, b, colonnaOrdinamento, direzioneOrdinamento));
        renderTabella();
    }
    
    // Assegna il listener di ordinamento a tutte le colonne
    document.querySelectorAll('#tabella th').forEach((th) => {
        th.addEventListener('click', (e) => {
            const colKey = th.getAttribute('data-key');
            if (colKey) {
                ordinaTabella(colKey);
            }
        });
    });

    /**
     * Gestisce il caricamento e l'elaborazione del file Excel.
     */
    document.getElementById('upload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          const data = new Uint8Array(evt.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          
          // Imposta dateNF per leggere le date nel formato dd/mm/yyyy
          const json = XLSX.utils.sheet_to_json(sheet, { header:1, raw:false, dateNF: 'dd/mm/yyyy' }); 
          
          atleti = json.slice(1).map(row => ({
            pettorale: row[colonneMappate.pettorale] || '',
            cognome: row[colonneMappate.cognome] || '',
            nome: row[colonneMappate.nome] || '',
            sesso: row[colonneMappate.sesso] || '',
            dataNascita: row[colonneMappate.dataNascita] || '',
            categoria1: row[colonneMappate.categoria1] || '',
            societa: row[colonneMappate.societa] || '',
          }));
          
          colonnaOrdinamento = null; 
          direzioneOrdinamento = 'asc';
          
          renderTabella();
        } catch (err) {
          alert('Errore nel caricamento del file. Assicurati che il formato sia corretto: ' + err.message);
        }
      };
      reader.readAsArrayBuffer(file);
    });

    document.getElementById('filtroSesso').addEventListener('change', renderTabella);
    document.getElementById('svuota-btn').addEventListener('click', svuotaTabella);


    /**
     * Aggiorna il DOM della tabella applicando filtri e ordinamento.
     */
    function renderTabella() {
      const filtro = document.getElementById('filtroSesso').value;
      const tbody = document.querySelector('#tabella tbody');
      const tableWrapper = document.querySelector('.table-wrapper');
      const noData = document.getElementById('no-data');

      // Aggiorna l'indicatore di ordinamento nell'header
      document.querySelectorAll('#tabella th').forEach(th => {
          const icon = th.querySelector('.sort-icon');
          if (icon) {
              icon.textContent = '↕';
              icon.className = 'sort-icon default';
          }
      });

      if (colonnaOrdinamento) {
          const th = document.querySelector(`#tabella th[data-key="${colonnaOrdinamento}"]`);
          if (th) {
              const icon = th.querySelector('.sort-icon');
              if (icon) {
                  // Simula le frecce: ▲ (crescente) e ▼ (decrescente)
                  icon.textContent = direzioneOrdinamento === 'asc' ? '▲' : '▼'; 
                  icon.className = `sort-icon ${direzioneOrdinamento}`;
              }
          }
      }
      
      let filtrati = atleti;
      if (filtro !== 'Tutti') {
        filtrati = atleti.filter(a => a.sesso === filtro);
      }
      
      tbody.innerHTML = '';
      document.getElementById('atleti-count').textContent = filtrati.length;

      // Gestione visualizzazione placeholder/tabella
      if (atleti.length === 0) {
        noData.style.display = 'block';
        tableWrapper.style.display = 'none';
        document.getElementById('atleti-count').textContent = 0;
        return;
      } else {
        noData.style.display = 'none';
        tableWrapper.style.display = 'block';
      }
      
      if (filtrati.length === 0 && atleti.length > 0) {
         tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 1.5rem; color: #6b7280;">Nessun atleta trovato con il filtro selezionato.</td></tr>';
         return;
      }

      // Popola la tabella con i dati filtrati e ordinati
      filtrati.forEach(a => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${a.pettorale}</td>
          <td>${a.cognome}</td>
          <td>${a.nome}</td>
          <td>${a.sesso}</td>
          <td>${a.dataNascita}</td>
          <td>${a.categoria1}</td>
          <td>${a.societa}</td>
        `;
        tbody.appendChild(row);
      });
    }

    /**
     * Svuota completamente l'array dei dati.
     */
    function svuotaTabella() {
      if (confirm('Sei sicuro di voler svuotare la tabella? Questa azione non può essere annullata.')) {
        atleti = [];
        colonnaOrdinamento = null; 
        direzioneOrdinamento = 'asc';
        renderTabella();
      }
    }
    
    // Inizializzazione all'apertura della pagina
    document.addEventListener('DOMContentLoaded', renderTabella);

  </script>
</body>
</html>
