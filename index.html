import React, { useState, useMemo } from 'react';
import { Upload, Trash2, ArrowUpDown, ArrowUp, ArrowDown, Save, X } from 'lucide-react';
import * as XLSX from 'xlsx';

const GestioneClassifiche = () => {
  const [atleti, setAtleti] = useState([]);
  const [sortConfig, setSortConfig] = useState({ key: null, direction: 'asc' });
  const [filtroSesso, setFiltroSesso] = useState('Tutti');
  const [editingCell, setEditingCell] = useState(null);
  const [editValue, setEditValue] = useState('');

  const handleFileUpload = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false, dateNF: 'dd/mm/yyyy' });

        const atletiProcessati = jsonData.map((row, index) => {
          const nome = row['Nome'] || row['nome'] || '';
          const cognome = row['Cognome'] || row['cognome'] || '';
          const nominativo = row['Nominativo'] || row['nominativo'] || `${nome} ${cognome}`.trim();
          
          // Gestione data di nascita
          let dataNascita = '';
          const dataField = row['Data di nascita'] || row['Data Nascita'] || row['dataNascita'] || row['data di nascita'] || '';
          if (dataField) {
            // Se Ã¨ un numero seriale di Excel
            if (typeof dataField === 'number') {
              const date = XLSX.SSF.parse_date_code(dataField);
              dataNascita = `${String(date.d).padStart(2, '0')}/${String(date.m).padStart(2, '0')}/${date.y}`;
            } else {
              dataNascita = dataField;
            }
          }
          
          return {
            id: index,
            pettorale: row['Numero di pettorale'] || row['Pettorale'] || row['pettorale'] || row['Numero pettorale'] || '',
            cognome: cognome,
            nome: nome,
            nominativo: nominativo,
            sesso: row['Sesso'] || row['sesso'] || '',
            dataNascita: dataNascita,
            categoria1: row['Categoria1'] || row['categoria1'] || '',
            societa: row['SocietÃ '] || row['Societa'] || row['societÃ '] || row['societa'] || '',
            comitato: row['Comitato'] || row['comitato'] || 'Sondrio',
            codiceComitato: row['Codice comitato'] || row['Codice Comitato'] || row['codiceComitato'] || '23',
            codiceSocieta: row['Codice societÃ '] || row['Codice SocietÃ '] || row['Codice societa'] || row['codiceSocieta'] || '',
            tipologia: row['Tipologia'] || row['tipologia'] || 'AT',
            tessera: row['NÂ° Tessera'] || row['Tessera'] || row['tessera'] || row['N Tessera'] || row['NÂ°Tessera'] || '',
            categoria2: row['Categoria2'] || row['categoria2'] || ''
          };
        });

        setAtleti(atletiProcessati);
      } catch (error) {
        alert('Errore nel caricamento del file: ' + error.message);
      }
    };
    reader.readAsArrayBuffer(file);
  };

  const svuotaDatabase = () => {
    if (window.confirm('Sei sicuro di voler svuotare il database?')) {
      setAtleti([]);
      setSortConfig({ key: null, direction: 'asc' });
    }
  };

  const handleSort = (key) => {
    let direction = 'asc';
    if (sortConfig.key === key && sortConfig.direction === 'asc') {
      direction = 'desc';
    }
    setSortConfig({ key, direction });
  };

  const startEdit = (atletaId, field, currentValue) => {
    setEditingCell({ atletaId, field });
    setEditValue(currentValue || '');
  };

  const saveEdit = () => {
    if (editingCell) {
      setAtleti(atleti.map(atleta => 
        atleta.id === editingCell.atletaId 
          ? { ...atleta, [editingCell.field]: editValue }
          : atleta
      ));
      setEditingCell(null);
      setEditValue('');
    }
  };

  const cancelEdit = () => {
    setEditingCell(null);
    setEditValue('');
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Enter') {
      saveEdit();
    } else if (e.key === 'Escape') {
      cancelEdit();
    }
  };

  const atletiFiltrati = useMemo(() => {
    let filtered = [...atleti];
    
    if (filtroSesso !== 'Tutti') {
      filtered = filtered.filter(a => a.sesso === filtroSesso);
    }

    if (sortConfig.key) {
      filtered.sort((a, b) => {
        let aVal = a[sortConfig.key];
        let bVal = b[sortConfig.key];

        if (sortConfig.key === 'pettorale') {
          aVal = Number(aVal) || 0;
          bVal = Number(bVal) || 0;
        }

        if (aVal < bVal) {
          return sortConfig.direction === 'asc' ? -1 : 1;
        }
        if (aVal > bVal) {
          return sortConfig.direction === 'asc' ? 1 : -1;
        }
        return 0;
      });
    }

    return filtered;
  }, [atleti, sortConfig, filtroSesso]);

  const SortIcon = ({ columnKey }) => {
    if (sortConfig.key !== columnKey) {
      return <ArrowUpDown className="w-4 h-4 opacity-40" />;
    }
    return sortConfig.direction === 'asc' ? 
      <ArrowUp className="w-4 h-4" /> : 
      <ArrowDown className="w-4 h-4" />;
  };

  const EditableCell = ({ atleta, field, value }) => {
    const isEditing = editingCell?.atletaId === atleta.id && editingCell?.field === field;

    if (isEditing) {
      return (
        <div className="flex items-center gap-1">
          {field === 'sesso' ? (
            <select
              value={editValue}
              onChange={(e) => setEditValue(e.target.value)}
              onKeyDown={handleKeyDown}
              autoFocus
              className="w-full px-1 py-1 border border-blue-500 rounded focus:outline-none"
            >
              <option value="">-</option>
              <option value="M">M</option>
              <option value="F">F</option>
            </select>
          ) : (
            <input
              type="text"
              value={editValue}
              onChange={(e) => setEditValue(e.target.value)}
              onKeyDown={handleKeyDown}
              autoFocus
              className="w-full px-1 py-1 border border-blue-500 rounded focus:outline-none"
            />
          )}
          <button onClick={saveEdit} className="text-green-600 hover:text-green-800">
            <Save className="w-4 h-4" />
          </button>
          <button onClick={cancelEdit} className="text-red-600 hover:text-red-800">
            <X className="w-4 h-4" />
          </button>
        </div>
      );
    }

    return (
      <div
        onClick={() => startEdit(atleta.id, field, value)}
        className="cursor-pointer hover:bg-blue-50 px-1 py-1 rounded min-h-[24px]"
        title="Clicca per modificare"
      >
        {value || '-'}
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-6">
      <div className="max-w-full mx-auto">
        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
          <h1 className="text-3xl font-bold text-gray-800 mb-6">
            Gestione Classifiche Gara Campestre
          </h1>

          <div className="flex flex-wrap gap-4 mb-6">
            <label className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 cursor-pointer transition-colors">
              <Upload className="w-5 h-5" />
              <span>Importa Excel</span>
              <input
                type="file"
                accept=".xlsx,.xls"
                onChange={handleFileUpload}
                className="hidden"
              />
            </label>

            <button
              onClick={svuotaDatabase}
              className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
              disabled={atleti.length === 0}
            >
              <Trash2 className="w-5 h-5" />
              Svuota Database
            </button>

            <select
              value={filtroSesso}
              onChange={(e) => setFiltroSesso(e.target.value)}
              className="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="Tutti">Tutti</option>
              <option value="M">Maschile</option>
              <option value="F">Femminile</option>
            </select>

            <div className="ml-auto text-gray-600 font-semibold py-2">
              Atleti: {atletiFiltrati.length}
            </div>
          </div>

          {atleti.length === 0 ? (
            <div className="text-center py-12 text-gray-500">
              <Upload className="w-16 h-16 mx-auto mb-4 opacity-30" />
              <p className="text-lg">Nessun atleta nel database</p>
              <p className="text-sm">Carica un file Excel per iniziare</p>
            </div>
          ) : (
            <div className="overflow-x-auto">
              <div className="text-sm text-gray-600 mb-2">
                ðŸ’¡ Clicca su qualsiasi cella per modificarla
              </div>
              <table className="w-full border-collapse text-sm">
                <thead>
                  <tr className="bg-gray-100">
                    <th className="border border-gray-300 px-2 py-2 text-left whitespace-nowrap">
                      <button
                        onClick={() => handleSort('pettorale')}
                        className="flex items-center gap-1 hover:text-blue-600 w-full"
                      >
                        Pettorale <SortIcon columnKey="pettorale" />
                      </button>
                    </th>
                    <th className="border border-gray-300 px-2 py-2 text-left whitespace-nowrap">
                      <button
                        onClick={() => handleSort('cognome')}
                        className="flex items-center gap-1 hover:text-blue-600 w-full"
                      >
                        Cognome <SortIcon columnKey="cognome" />
                      </button>
                    </th>
                    <th className="border border-gray-300 px-2 py-2 text-left whitespace-nowrap">
                      <button
                        onClick={() => handleSort('nome')}
                        className="flex items-center gap-1 hover:text-blue-600 w-full"
                      >
                        Nome <SortIcon columnKey="nome" />
                      </button>
                    </th>
                    <th className="border border-gray-300 px-2 py-2 text-left whitespace-nowrap">
                      <button
                        onClick={() => handleSort('nominativo')}
                        className="flex items-center gap-1 hover:text-blue-600 w-full"
                      >
                        Nominativo <SortIcon columnKey="nominativo" />
                      </button>
                    </th>
                    <th className="border border-gray-300 px-2 py-2 text-left whitespace-nowrap">
                      <button
                        onClick={() => handleSort('sesso')}
                        className="flex items-center gap-1 hover:text-blue-600 w-full"
                      >
                        Sesso <SortIcon columnKey="sesso" />
                      </button>
                    </th>
                    <th className="border border-gray-300 px-2 py-2 text-left whitespace-nowrap">
                      <button
                        onClick={() => handleSort('dataNascita')}
                        className="flex items-center gap-1 hover:text-blue-600 w-full"
                      >
                        Data Nascita <SortIcon columnKey="dataNascita" />
                      </button>
                    </th>
                    <th className="border border-gray-300 px-2 py-2 text-left whitespace-nowrap">
                      <button
                        onClick={() => handleSort('categoria1')}
                        className="flex items-center gap-1 hover:text-blue-600 w-full"
                      >
                        Categoria1 <SortIcon columnKey="categoria1" />
                      </button>
                    </th>
                    <th className="border border-gray-300 px-2 py-2 text-left whitespace-nowrap">
                      <button
                        onClick={() => handleSort('societa')}
                        className="flex items-center gap-1 hover:text-blue-600 w-full"
                      >
                        SocietÃ  <SortIcon columnKey="societa" />
                      </button>
                    </th>
                    <th className="border border-gray-300 px-2 py-2 text-left whitespace-nowrap">
                      <button
                        onClick={() => handleSort('comitato')}
                        className="flex items-center gap-1 hover:text-blue-600 w-full"
                      >
                        Comitato <SortIcon columnKey="comitato" />
                      </button>
                    </th>
                    <th className="border border-gray-300 px-2 py-2 text-left whitespace-nowrap">
                      <button
                        onClick={() => handleSort('codiceComitato')}
                        className="flex items-center gap-1 hover:text-blue-600 w-full"
                      >
                        Cod. Comitato <SortIcon columnKey="codiceComitato" />
                      </button>
                    </th>
                    <th className="border border-gray-300 px-2 py-2 text-left whitespace-nowrap">
                      <button
                        onClick={() => handleSort('codiceSocieta')}
                        className="flex items-center gap-1 hover:text-blue-600 w-full"
                      >
                        Cod. SocietÃ  <SortIcon columnKey="codiceSocieta" />
                      </button>
                    </th>
                    <th className="border border-gray-300 px-2 py-2 text-left whitespace-nowrap">
                      <button
                        onClick={() => handleSort('tipologia')}
                        className="flex items-center gap-1 hover:text-blue-600 w-full"
                      >
                        Tipologia <SortIcon columnKey="tipologia" />
                      </button>
                    </th>
                    <th className="border border-gray-300 px-2 py-2 text-left whitespace-nowrap">
                      <button
                        onClick={() => handleSort('tessera')}
                        className="flex items-center gap-1 hover:text-blue-600 w-full"
                      >
                        NÂ° Tessera <SortIcon columnKey="tessera" />
                      </button>
                    </th>
                    <th className="border border-gray-300 px-2 py-2 text-left whitespace-nowrap">
                      <button
                        onClick={() => handleSort('categoria2')}
                        className="flex items-center gap-1 hover:text-blue-600 w-full"
                      >
                        Categoria2 <SortIcon columnKey="categoria2" />
                      </button>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {atletiFiltrati.map((atleta) => (
                    <tr key={atleta.id} className="hover:bg-gray-50">
                      <td className="border border-gray-300 px-2 py-1">
                        <EditableCell atleta={atleta} field="pettorale" value={atleta.pettorale} />
                      </td>
                      <td className="border border-gray-300 px-2 py-1">
                        <EditableCell atleta={atleta} field="cognome" value={atleta.cognome} />
                      </td>
                      <td className="border border-gray-300 px-2 py-1">
                        <EditableCell atleta={atleta} field="nome" value={atleta.nome} />
                      </td>
                      <td className="border border-gray-300 px-2 py-1">
                        <EditableCell atleta={atleta} field="nominativo" value={atleta.nominativo} />
                      </td>
                      <td className="border border-gray-300 px-2 py-1">
                        <EditableCell atleta={atleta} field="sesso" value={atleta.sesso} />
                      </td>
                      <td className="border border-gray-300 px-2 py-1">
                        <EditableCell atleta={atleta} field="dataNascita" value={atleta.dataNascita} />
                      </td>
                      <td className="border border-gray-300 px-2 py-1">
                        <EditableCell atleta={atleta} field="categoria1" value={atleta.categoria1} />
                      </td>
                      <td className="border border-gray-300 px-2 py-1">
                        <EditableCell atleta={atleta} field="societa" value={atleta.societa} />
                      </td>
                      <td className="border border-gray-300 px-2 py-1">
                        <EditableCell atleta={atleta} field="comitato" value={atleta.comitato} />
                      </td>
                      <td className="border border-gray-300 px-2 py-1">
                        <EditableCell atleta={atleta} field="codiceComitato" value={atleta.codiceComitato} />
                      </td>
                      <td className="border border-gray-300 px-2 py-1">
                        <EditableCell atleta={atleta} field="codiceSocieta" value={atleta.codiceSocieta} />
                      </td>
                      <td className="border border-gray-300 px-2 py-1">
                        <EditableCell atleta={atleta} field="tipologia" value={atleta.tipologia} />
                      </td>
                      <td className="border border-gray-300 px-2 py-1">
                        <EditableCell atleta={atleta} field="tessera" value={atleta.tessera} />
                      </td>
                      <td className="border border-gray-300 px-2 py-1">
                        <EditableCell atleta={atleta} field="categoria2" value={atleta.categoria2} />
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default GestioneClassifiche;
